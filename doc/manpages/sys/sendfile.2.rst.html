<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>sendfile.2.rst</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<hr class="docutils" />
<p>SENDFILE(2) BSD System Calls Manual SENDFILE(2)</p>
<p><strong>NAME</strong></p>
<p><strong>sendfile</strong> — send a file to a socket</p>
<p><strong>LIBRARY</strong></p>
<p>Standard C&nbsp;Library (libc, −lc)</p>
<p><strong>SYNOPSIS</strong></p>
<p><strong>#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/uio.h&gt;</strong></p>
<p><em>int</em></p>
<p><strong>sendfile</strong>(<em>int&nbsp;fd</em>, <em>int&nbsp;s</em>, <em>off_t&nbsp;offset</em>, <em>size_t&nbsp;nbytes</em>,
<em>struct&nbsp;sf_hdtr&nbsp;*hdtr</em>, <em>off_t&nbsp;*sbytes</em>, <em>int&nbsp;flags</em>);</p>
<p><strong>DESCRIPTION</strong></p>
<p>The <strong>sendfile</strong>() system call sends a regular file or shared memory
object specified by descriptor <em>fd</em> out a stream socket specified by
descriptor <em>s</em>.</p>
<p>The <em>offset</em> argument specifies where to begin in the file. Should
<em>offset</em> fall beyond the end of file, the system will return success and
report 0 bytes sent as described below. The <em>nbytes</em> argument specifies
how many bytes of the file should be sent, with 0 having the special
meaning of send until the end of file has been reached.</p>
<p>An optional header and/or trailer can be sent before and after the file
data by specifying a pointer to a <em>struct sf_hdtr</em>, which has the
following structure:</p>
<p>struct sf_hdtr {</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
</colgroup>
<tbody valign="top">
<tr><td>&nbsp;</td>
<td>struct
iovec
*headers
;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>/*
pointer
to header
iovecs
*/</td>
<td>&nbsp;</td>
</tr>
<tr><td>&nbsp;</td>
<td>int
hdr_cnt;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>/*
number of
header
iovecs
*/</td>
<td>&nbsp;</td>
</tr>
<tr><td>&nbsp;</td>
<td>struct
iovec
*trailer
s;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>/*
pointer
to
trailer
iovecs
*/</td>
<td>&nbsp;</td>
</tr>
<tr><td>&nbsp;</td>
<td>int
trl_cnt;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>/*
number of
trailer
iovecs
*/</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>};</p>
<p>The <em>headers</em> and <em>trailers</em> pointers, if non-NULL, point to arrays of
<em>struct iovec</em> structures. See the <strong>writev</strong>() system call for
information on the iovec structure. The number of iovecs in these arrays
is specified by <em>hdr_cnt</em> and <em>trl_cnt</em>.</p>
<p>If non-NULL, the system will write the total number of bytes sent on the
socket to the variable pointed to by <em>sbytes</em>.</p>
<p>The least significant 16 bits of <em>flags</em> argument is a bitmap of these
values:</p>
<p>SF_NODISKIO</p>
<p>This flag causes <strong>sendfile</strong> to return EBUSY instead of blocking when a
busy page is encountered. This rare situation can happen if some other
process is now working with the same region of the file. It is advised
to retry the operation after a short period.</p>
<p>Note that in older FreeBSD versions the SF_NODISKIO had slightly
different notion. The flag prevented <strong>sendfile</strong> to run I/O operations
in case if an invalid (not cached) page is encountered, thus avoiding
blocking on I/O. Starting with FreeBSD&nbsp;11 <strong>sendfile</strong> sending files off
the ffs(7) filesystem does not block on I/O (see <em>IMPLEMENTATION NOTES</em>
), so the condition no longer applies. However, it is safe if an
application utilizes SF_NODISKIO and on EBUSY performs the same action
as it did in older FreeBSD versions, e.g., aio_read(2), read(2) or
<strong>sendfile</strong> in a different context.</p>
<p>SF_NOCACHE</p>
<p>The data sent to socket will not be cached by the virtual memory system,
and will be freed directly to the pool of free pages.</p>
<p>SF_SYNC</p>
<p><strong>sendfile</strong> sleeps until the network stack no longer references the VM
pages of the file, making subsequent modifications to it safe. Please
note that this is not a guarantee that the data has actually been sent.</p>
<p>SF_USER_READAHEAD</p>
<p><strong>sendfile</strong> has some internal heuristics to do readahead when sending
data. This flag forces <strong>sendfile</strong> to override any heuristically
calculated readahead and use exactly the application specified
readahead. See <em>SETTING READAHEAD</em> for more details on readahead.</p>
<p>When using a socket marked for non-blocking I/O, <strong>sendfile</strong>() may
send fewer bytes than requested. In this case, the number of bytes
successfully written is returned in <em>*sbytes</em> (if specified), and the
error EAGAIN is returned.</p>
<p><strong>SETTING READAHEAD</strong></p>
<p><strong>sendfile</strong> uses internal heuristics based on request size and file
system layout to do readahead. Additionally application may request
extra readahead. The most significant 16 bits of <em>flags</em> specify amount
of pages that <strong>sendfile</strong> may read ahead when reading the file. A macro
<strong>SF_FLAGS</strong>() is provided to combine readahead amount and flags. An
example showing specifying readahead of 16 pages and SF_NOCACHE flag:</p>
<p>SF_FLAGS(16, SF_NOCACHE)</p>
<p><strong>sendfile</strong> will use either application specified readahead or
internally calculated, whichever is bigger. Setting flag
SF_USER_READAHEAD would turn off any heuristics and set maximum possible
readahead length to the number of pages specified via flags.</p>
<p><strong>IMPLEMENTATION NOTES</strong></p>
<p>The FreeBSD implementation of <strong>sendfile</strong>() does not block on disk
I/O when it sends a file off the ffs(7) filesystem. The syscall returns
success before the actual I/O completes, and data is put into the socket
later unattended. However, the order of data in the socket is preserved,
so it is safe to do further writes to the socket.</p>
<p>The FreeBSD implementation of <strong>sendfile</strong>() is &quot;zero-copy&quot;, meaning
that it has been optimized so that copying of the file data is avoided.</p>
<p><strong>TUNING</strong></p>
<p><strong>physical paging buffers
sendfile</strong>() uses vnode pager to read file pages into memory. The
pager uses a pool of physical buffers to run its I/O operations. When
system runs out of pbufs, sendfile will block and report state
‘‘zonelimit’’. Size of the pool can be tuned with <em>vm.vnode_pbufs</em>
loader.conf(5) tunable and can be checked with sysctl(8) OID of the same
name at runtime.</p>
<div class="line-block">
<div class="line"><strong>sendfile(2) buffers</strong></div>
<div class="line">On some architectures, this system call internally uses a special
<strong>sendfile</strong>() buffer (<em>struct sf_buf</em>) to handle sending file data
to the client. If the sending socket is blocking, and there are not
enough <strong>sendfile</strong>() buffers available, <strong>sendfile</strong>() will block
and report a state of ‘‘sfbufa’’. If the sending socket is
non-blocking and there are not enough <strong>sendfile</strong>() buffers
available, the call will block and wait for the necessary buffers to
become available before finishing the call.</div>
</div>
<p>The number of <em>sf_buf</em>’s allocated should be proportional to the
number of nmbclusters used to send data to a client via
<strong>sendfile</strong>(). Tune accordingly to avoid blocking! Busy installations
that make extensive use of <strong>sendfile</strong>() may want to increase these
values to be inline with their <em>kern.ipc.nmbclusters</em> (see tuning(7) for
details).</p>
<p>The number of <strong>sendfile</strong>() buffers available is determined at boot
time by either the <em>kern.ipc.nsfbufs</em> loader.conf(5) variable or the
NSFBUFS kernel configuration tunable. The number of <strong>sendfile</strong>()
buffers scales with <em>kern.maxusers</em>. The <em>kern.ipc.nsfbufsused</em> and
<em>kern.ipc.nsfbufspeak</em> read-only sysctl(8) variables show current and
peak <strong>sendfile</strong>() buffers usage respectively. These values may also
be viewed through <strong>netstat −m</strong>.</p>
<p>If sysctl(8) OID <em>kern.ipc.nsfbufs</em> doesn’t exist, your architecture
does not need to use <strong>sendfile</strong>() buffers because their task can be
efficiently performed by the generic virtual memory structures.</p>
<p><strong>RETURN VALUES</strong></p>
<p>The <strong>sendfile</strong>() function returns the value&nbsp;0 if successful;
otherwise the value&nbsp;−1 is returned and the global variable <em>errno</em> is
set to indicate the error.</p>
<div class="line-block">
<div class="line"><strong>ERRORS</strong></div>
<div class="line">[EAGAIN]</div>
</div>
<p>The socket is marked for non-blocking I/O and not all data was sent due
to the socket buffer being filled. If specified, the number of bytes
successfully sent will be returned in <em>*sbytes</em>.</p>
<p>[EBADF]</p>
<p>The <em>fd</em> argument is not a valid file descriptor.</p>
<p>[EBADF]</p>
<p>The <em>s</em> argument is not a valid socket descriptor.</p>
<p>[EBUSY]</p>
<p>A busy page was encountered and SF_NODISKIO had been specified. Partial
data may have been sent.</p>
<p>[EFAULT]</p>
<p>An invalid address was specified for an argument.</p>
<p>[EINTR]</p>
<p>A signal interrupted <strong>sendfile</strong>() before it could be completed. If
specified, the number of bytes successfully sent will be returned in
<em>*sbytes</em>.</p>
<p>[EINVAL]</p>
<p>The <em>fd</em> argument is not a regular file.</p>
<p>[EINVAL]</p>
<p>The <em>s</em> argument is not a SOCK_STREAM type socket.</p>
<p>[EINVAL]</p>
<p>The <em>offset</em> argument is negative.</p>
<p>[EIO]</p>
<p>An error occurred while reading from <em>fd</em>.</p>
<p>[ENOTCAPABLE]</p>
<p>The <em>fd</em> or the <em>s</em> argument has insufficient rights.</p>
<p>[ENOBUFS]</p>
<p>The system was unable to allocate an internal buffer.</p>
<p>[ENOTCONN]</p>
<p>The <em>s</em> argument points to an unconnected socket.</p>
<p>[ENOTSOCK]</p>
<p>The <em>s</em> argument is not a socket.</p>
<p>[EOPNOTSUPP]</p>
<p>The file system for descriptor <em>fd</em> does not support <strong>sendfile</strong>().</p>
<p>[EPIPE]</p>
<p>The socket peer has closed the connection.</p>
<p><strong>SEE ALSO</strong></p>
<p>loader.conf(5), netstat(1), open(2), send(2), socket(2), writev(2),
sysctl(8), tuning(7)</p>
<ol class="upperalpha simple" start="11">
<li>Elmeleegy</li>
</ol>
<p>,</p>
<div class="line-block">
<div class="line">A. Chanda ,</div>
<div class="line">A. L. Cox , and</div>
<div class="line">W. Zwaenepoel , &quot;</div>
<div class="line">A Portable Kernel Abstraction for Low-Overhead Ephemeral Mapping
Management &quot;, *
The Proceedings of the 2005 USENIX Annual Technical Conference* ,</div>
<div class="line">pp 223-236 ,</div>
<div class="line">2005 .</div>
</div>
<p><strong>HISTORY</strong></p>
<p>The <strong>sendfile</strong>() system call first appeared in FreeBSD&nbsp;3.0. This
manual page first appeared in FreeBSD&nbsp;3.1. In FreeBSD&nbsp;10 support for
sending shared memory descriptors had been introduced. In FreeBSD&nbsp;11 a
non-blocking implementation had been introduced.</p>
<p><strong>AUTHORS</strong></p>
<div class="line-block">
<div class="line">The initial implementation of <strong>sendfile</strong>() system call and this
manual page were written by David G. Lawrence &lt;<em>dg&#64;dglawrence.com</em>&gt;.
The FreeBSD&nbsp;11 implementation was written by</div>
<div class="line">Gleb Smirnoff &lt;<em>glebius&#64;FreeBSD.org</em>&gt;.</div>
</div>
<p><strong>BUGS</strong></p>
<p>The <strong>sendfile</strong>() system call will not fail, i.e., return -1 and set
<em>errno</em> to EFAULT, if provided an invalid address for <em>sbytes</em>.</p>
<p>BSD February&nbsp;15, 2019 BSD</p>
<hr class="docutils" />
<!-- Copyright (c) 1990, 1991, 1993 -->
<!-- The Regents of the University of California.  All rights reserved. -->
<!--  -->
<!-- This code is derived from software contributed to Berkeley by -->
<!-- Chris Torek and the American National Standards Committee X3, -->
<!-- on Information Processing Systems. -->
<!--  -->
<!-- Redistribution and use in source and binary forms, with or without -->
<!-- modification, are permitted provided that the following conditions -->
<!-- are met: -->
<!-- 1. Redistributions of source code must retain the above copyright -->
<!-- notice, this list of conditions and the following disclaimer. -->
<!-- 2. Redistributions in binary form must reproduce the above copyright -->
<!-- notice, this list of conditions and the following disclaimer in the -->
<!-- documentation and/or other materials provided with the distribution. -->
<!-- 3. Neither the name of the University nor the names of its contributors -->
<!-- may be used to endorse or promote products derived from this software -->
<!-- without specific prior written permission. -->
<!--  -->
<!-- THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND -->
<!-- ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE -->
<!-- IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE -->
<!-- ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE -->
<!-- FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL -->
<!-- DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS -->
<!-- OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) -->
<!-- HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT -->
<!-- LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY -->
<!-- OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF -->
<!-- SUCH DAMAGE. -->
</div>
</body>
</html>
